<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PCR Ê∏†ÈÅìÊúçÂ∑•ÂÖ∑ÁÆ±</title>
    <link rel="shortcut icon" type="image/x-icon" href="/static/128431.ico" />
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.js"></script>
</head>

<body>
    <div id="app">
        <!-- ÂØºËà™Ê†è -->
        <nav class="navbar">
            <div class="navbar-container">
                <a class="navbar-brand" href="/">
                    <img src="/static/128431.ico" alt="Logo" style="height: 28px;">
                    PCR Ê∏†ÈÅìÊúçÂ∑•ÂÖ∑ÁÆ±
                </a>
                <div class="navbar-menu">
                    <span class="navbar-item" :class="{ active: currentTab === 'clan_battle' }"
                        @click="currentTab = 'clan_battle'">
                        ‰ºöÊàòÊü•ËØ¢
                    </span>
                    <span class="navbar-item" :class="{ active: currentTab === 'clan' }"
                        @click="currentTab = auth.isLoggedIn ? 'clan' : 'login'">
                        ÂÖ¨‰ºöÊü•ËØ¢
                    </span>
                    <span class="navbar-item" :class="{ active: currentTab === 'grand' }"
                        @click="currentTab = auth.isLoggedIn ? 'grand' : 'login'">
                        ÂèåÂú∫Êü•ËØ¢
                    </span>
                    <span class="navbar-item" :class="{ active: currentTab === 'player' }"
                        @click="currentTab = auth.isLoggedIn ? 'player' : 'login'">
                        Áé©ÂÆ∂Êü•ËØ¢
                    </span>
                    <span class="navbar-item" :class="{ active: currentTab === 'admin' }"
                        v-if="auth.isLoggedIn && auth.role === 'admin'" @click="currentTab = 'admin'"
                        style="color: var(--primary-color);">
                        ÁÆ°ÁêÜÈù¢Êùø
                    </span>

                    <!-- ÁôªÂΩïÁä∂ÊÄÅ -->
                    <span v-if="auth.isLoggedIn" class="navbar-item" style="color: var(--primary-color);">
                        {{ auth.username }}
                        <span @click="logout" style="margin-left: 0.5rem; font-size: 0.9rem; cursor: pointer;">ÁôªÂá∫</span>
                    </span>
                    <span v-else class="navbar-item" :class="{ active: currentTab === 'login' }"
                        @click="currentTab = 'login'" style="cursor: pointer;">
                        ÁôªÂΩï
                    </span>
                </div>
            </div>
        </nav>

        <div class="container fade-in">
            <!-- ‰ºöÊàòÊü•ËØ¢ Tab -->
            <div v-show="currentTab === 'clan_battle'">
                <div class="notice-banner">
                    <span class="notice-badge">üöß ÂäüËÉΩÂÜÖÊµã‰∏≠</span>
                    <span>‚ú® Ê∏†ÈÅìÊúç‰ø°ÊÅØÊü•ËØ¢ÂäüËÉΩÂºÄÂèëÂπ∂ÊµãËØï‰∏≠ÔºåÊúüÂæÖÊÇ®ÁöÑÂèçÈ¶àÔºåÊ¨¢ËøéÊèêÂá∫Êñ∞ÂäüËÉΩÊàñÂèÇ‰∏éÂºÄÂèë</span>
                    <span class="notice-separator">|</span>
                    <span>ÂÖ≥Ê≥®È°πÁõÆÔºö<a href="https://github.com/lumokato/pcrdb" target="_blank">GitHub</a></span>
                    <span class="notice-separator">|</span>
                    <span><a href="https://github.com/lumokato/pcrdb/issues" target="_blank">IssueÂèçÈ¶à</a></span>

                </div>
                <div class="card">
                    <div class="tab-container">
                        <button class="tab-btn" :class="{ active: clanBattle.mode === 'current' }"
                            @click="clanBattle.mode = 'current'; loadClanBattleTime()">
                            ÂΩìÊúü‰ºöÊàò
                        </button>
                        <button class="tab-btn" :class="{ active: clanBattle.mode === 'history' }"
                            @click="clanBattle.mode = 'history'; loadClanBattleHistory()">
                            ÂéÜÂè≤‰ºöÊàò
                        </button>
                    </div>

                    <div class="form-row">
                        <!-- ÂΩìÊúüÊ®°ÂºèÔºöÊó•Êúü+Êó∂Èó¥ -->
                        <template v-if="clanBattle.mode === 'current'">
                            <div class="form-group" style="flex: 1;">
                                <select class="form-control" v-model="clanBattle.selectedDate"
                                    @change="updateTimeOptions">
                                    <option v-for="(times, date) in clanBattle.timeData" :value="date">
                                        {{ formatDate(date) }}
                                    </option>
                                </select>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <select class="form-control" v-model="clanBattle.selectedTime">
                                    <option v-for="time in clanBattle.timeData[clanBattle.selectedDate]" :value="time">
                                        {{ formatTime(time) }}
                                    </option>
                                </select>
                            </div>
                        </template>

                        <!-- ÂéÜÂè≤Ê®°ÂºèÔºöÊúà‰ªΩ -->
                        <template v-else>
                            <div class="form-group" style="flex: 2;">
                                <select class="form-control" v-model="clanBattle.selectedHistory">
                                    <option v-for="h in clanBattle.historyData" :value="h">{{ h }}</option>
                                </select>
                            </div>
                        </template>

                        <div class="form-group" style="flex: 2;">
                            <input type="text" class="form-control" placeholder="ÂÖ¨‰ºöÂêçÔºàÊîØÊåÅÊ≠£ÂàôÔºâ"
                                v-model="clanBattle.searchText" @keyup.enter="searchClanBattle(0)">
                        </div>
                        <div class="form-group">
                            <button class="btn" @click="searchClanBattle(0)" :disabled="clanBattle.loading">
                                Êü•ËØ¢
                            </button>
                        </div>
                        <div class="form-group">
                            <button class="btn btn-secondary" @click="searchScoreLine()" :disabled="clanBattle.loading">
                                Êü•Ê°£Á∫ø
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ‰ºöÊàòÁªìÊûúË°®Ê†º -->
                <div class="card" v-if="clanBattle.results.length > 0">
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 60px;">ÊéíÂêç</th>
                                <th style="width: 200px;">ÂÖ¨‰ºöÂêç</th>
                                <th style="width: 60px;">‰∫∫Êï∞</th>
                                <th style="width: 140px;">‰ºöÈïø</th>
                                <th style="width: 160px;">ÂàÜÊï∞</th>
                                <th style="width: 60px;">Âë®ÁõÆ</th>
                                <th style="width: 60px;">‰∏äÊúü</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="row in clanBattle.results">
                                <td>{{ row.rank }}</td>
                                <td>{{ row.clan_name }}</td>
                                <td>{{ row.member_num }}</td>
                                <td>{{ row.leader_name }}</td>
                                <td>{{ row.damage?.toLocaleString() }}</td>
                                <td>{{ row.lap }}</td>
                                <td>{{ row.grade_rank }}</td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="pagination">
                        <button class="btn btn-secondary" @click="clanBattlePage(-1)"
                            :disabled="clanBattle.page === 0">‰∏ä‰∏ÄÈ°µ</button>
                        <span>{{ clanBattle.page + 1 }} / {{ clanBattle.maxPage }}</span>
                        <button class="btn btn-secondary" @click="clanBattlePage(1)"
                            :disabled="clanBattle.page >= clanBattle.maxPage - 1">‰∏ã‰∏ÄÈ°µ</button>
                    </div>
                </div>

                <!-- ‰ºöÊàòÈîôËØØÊèêÁ§∫ -->
                <div v-if="clanBattle.errorOccured" class="error">
                    {{ clanBattle.errorMsg }}
                </div>
            </div>

            <!-- ÁôªÂΩï Tab -->
            <div v-show="currentTab === 'login'">
                <!-- ÁôªÂΩï/Ê≥®ÂÜåË°®Âçï -->
                <div class="card" style="max-width: 400px; margin: 0 auto;">
                    <div class="card-header">{{ auth.isRegisterMode ? 'Ê≥®ÂÜåË¥¶Âè∑' : 'ÁôªÂΩï' }}</div>

                    <!-- ÁôªÂΩïË°®ÂçïÔºàÁ´ñÂêëÔºâ -->
                    <div v-if="!auth.isRegisterMode">
                        <div class="form-group" style="margin-bottom: 0.8rem;">
                            <input type="text" class="form-control" placeholder="Áî®Êà∑ÂêçÊàñQQÂè∑" v-model="auth.loginId"
                                @keyup.enter="login">
                        </div>
                        <div class="form-group" style="margin-bottom: 0.8rem;">
                            <input type="password" class="form-control" placeholder="ÂØÜÁ†Å" v-model="auth.loginPassword"
                                @keyup.enter="login">
                        </div>
                        <button class="btn" style="width: 100%;" @click="login" :disabled="auth.loading">
                            ÁôªÂΩï
                        </button>
                    </div>

                    <!-- Ê≥®ÂÜåË°®ÂçïÔºàÁ´ñÂêëÔºâ -->
                    <div v-else>
                        <div class="form-group" style="margin-bottom: 0.8rem;">
                            <input type="text" class="form-control" placeholder="Áî®Êà∑Âêç" v-model="auth.registerUsername">
                        </div>
                        <div class="form-group" style="margin-bottom: 0.8rem;">
                            <input type="password" class="form-control" placeholder="ÂØÜÁ†ÅÔºàËá≥Â∞ë6‰ΩçÔºâ"
                                v-model="auth.registerPassword">
                        </div>
                        <div class="form-group" style="margin-bottom: 0.8rem;">
                            <input type="text" class="form-control" placeholder="QQÂè∑" v-model="auth.registerQQ">
                        </div>
                        <!-- È™åËØÅÁ†ÅÂ∑≤ÁßªÈô§ -->
                        <button class="btn" style="width: 100%;" @click="register" :disabled="auth.loading">
                            Ê≥®ÂÜå
                        </button>
                    </div>

                    <div style="margin-top: 1rem; text-align: center;">
                        <a href="#" @click.prevent="auth.isRegisterMode = !auth.isRegisterMode"
                            style="color: var(--primary-color); text-decoration: none;">
                            {{ auth.isRegisterMode ? 'Â∑≤ÊúâË¥¶Âè∑ÔºüÂéªÁôªÂΩï' : 'Ê≤°ÊúâË¥¶Âè∑ÔºüÂéªÊ≥®ÂÜå' }}
                        </a>
                    </div>
                    <div class="error" v-if="auth.error" style="margin-top: 0.5rem; text-align: center;">{{ auth.error
                        }}</div>
                </div>
            </div>

            <!-- ÂÖ®Â±ÄÂæÖÂÆ°Ê†∏ÊèêÁ§∫ -->
            <div class="container fade-in" v-if="auth.isLoggedIn && auth.status === 'pending'"
                style="margin-top: 2rem;">
                <div class="card" style="text-align: center; padding: 2rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">‚è≥</div>
                    <h3>Ë¥¶Âè∑ÂÆ°Ê†∏‰∏≠</h3>
                    <p style="color: var(--text-muted);">ÊÇ®ÁöÑË¥¶Âè∑Ê≠£Âú®Á≠âÂæÖÁÆ°ÁêÜÂëòÂÆ°Ê†∏ÔºåËØ∑ËÄêÂøÉÁ≠âÂæÖÊàñËÅîÁ≥ªÁÆ°ÁêÜÂëò„ÄÇ</p>
                    <button class="btn btn-secondary" @click="logout" style="margin-top: 1rem;">ÁôªÂá∫</button>
                    <button class="btn" @click="checkStatus" style="margin-top: 1rem; margin-left: 0.5rem;"
                        :disabled="auth.loading">Âà∑Êñ∞Áä∂ÊÄÅ</button>
                </div>
            </div>

            <!-- ÁÆ°ÁêÜÈù¢Êùø Tab -->
            <div v-show="currentTab === 'admin' && auth.role === 'admin'">
                <div class="card">
                    <div class="tab-container">
                        <button class="tab-btn" :class="{ active: admin.mode === 'users' }"
                            @click="admin.mode = 'users'; loadAdminUsers()">
                            Áî®Êà∑ÁÆ°ÁêÜ
                        </button>
                        <button class="tab-btn" :class="{ active: admin.mode === 'task_logs' }"
                            @click="admin.mode = 'task_logs'; loadTaskLogs()">
                            ‰ªªÂä°Êó•Âøó
                        </button>
                    </div>
                </div>

                <!-- Áî®Êà∑ÁÆ°ÁêÜ -->
                <div class="card" v-if="admin.mode === 'users'">
                    <div class="card-header">
                        Áî®Êà∑ÁÆ°ÁêÜ ({{ admin.users.length }})
                        <button class="btn btn-secondary" style="float: right; padding: 0.3rem 0.8rem;"
                            @click="loadApiStats" :disabled="admin.statsLoading">
                            Âà∑Êñ∞
                        </button>
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th style="width: 60px; text-align: center;">ID</th>
                                    <th style="width: 180px;">Áî®Êà∑Âêç</th>
                                    <th style="width: 100px; text-align: center;">Áî®Êà∑‰ø°ÊÅØ</th>
                                    <th style="width: 80px; text-align: center;">Áä∂ÊÄÅ</th>
                                    <th style="width: 100px; text-align: center;">Ë∞ÉÁî®Ê¨°Êï∞</th>
                                    <th style="width: 160px; text-align: center;">ÊúÄÂêéË∞ÉÁî®</th>
                                    <th style="width: 100px; text-align: center;">Ë∞ÉÁî®ËØ¶ÊÉÖ</th>
                                    <th style="width: 80px; text-align: center;">Êìç‰Ωú</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="user in admin.users" :key="user.id">
                                    <td style="text-align: center;">{{ user.id }}</td>
                                    <td>{{ user.username }}</td>
                                    <td style="text-align: center;">
                                        <button class="btn btn-secondary" @click="showUserInfo(user)"
                                            style="padding: 0.2rem 0.3rem; font-size: 0.85rem;">
                                            ‰ø°ÊÅØ
                                        </button>
                                    </td>
                                    <td style="text-align: center;">
                                        <span
                                            :style="{ color: user.status === 'active' ? 'var(--success-color, green)' : 'var(--warning-color, orange)' }">
                                            {{ user.status }}
                                        </span>
                                    </td>
                                    <td style="text-align: center;">{{ getApiCallCount(user.id) }}</td>
                                    <td style="white-space: nowrap; text-align: center;">{{ getLastCallTime(user.id) }}
                                    </td>
                                    <td style="text-align: center;">
                                        <button class="btn btn-secondary"
                                            @click="showApiDetails(user.id, user.username)"
                                            style="padding: 0.2rem 0.3rem; font-size: 0.85rem;">
                                            Êü•Áúã
                                        </button>
                                    </td>
                                    <td style="text-align: center;">
                                        <button v-if="user.status === 'pending'" class="btn"
                                            @click="adminApproveUser(user.id)" :disabled="admin.loading"
                                            style="padding: 0.2rem 0.3rem; font-size: 0.85rem;">
                                            ÈÄöËøá
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- ‰ªªÂä°Êó•Âøó -->
                <div class="card" v-if="admin.mode === 'task_logs'">
                    <div class="card-header">
                        ‰ªªÂä°ÊâßË°åÊó•Âøó
                        <button class="btn btn-secondary" style="float: right; padding: 0.3rem 0.8rem;"
                            @click="loadTaskLogs" :disabled="admin.taskLogsLoading">
                            Âà∑Êñ∞
                        </button>
                    </div>
                    <div style="overflow-x: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th style="width: 140px;">‰ªªÂä°Âêç</th>
                                    <th style="width: 60px; text-align: center;">Áä∂ÊÄÅ</th>
                                    <th style="width: 140px;">ÂºÄÂßãÊó∂Èó¥</th>
                                    <th style="width: 70px; text-align: right;">ËÄóÊó∂(Áßí)</th>
                                    <th style="width: 80px; text-align: right;">È¢ÑËÆ°</th>
                                    <th style="width: 80px; text-align: right;">Ëé∑Âèñ</th>
                                    <th style="width: 80px; text-align: right;">ÂÖ•Â∫ì</th>
                                    <th>Â§áÊ≥®</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="log in admin.taskLogs" :key="log.id">
                                    <td>{{ log.task_name }}</td>
                                    <td style="text-align: center;">
                                        <span :style="{ 
                                            color: log.status === 'success' ? 'var(--success-color, green)' : 'var(--error-color, red)',
                                            fontWeight: 'bold'
                                        }">
                                            {{ log.status === 'success' ? '‚úì' : '‚úó' }}
                                        </span>
                                    </td>
                                    <td>{{ formatDateTime(log.started_at) }}</td>
                                    <td style="text-align: right;">{{ log.duration_seconds?.toFixed(1) }}</td>
                                    <td style="text-align: right;">{{ log.records_expected }}</td>
                                    <td style="text-align: right;">{{ log.records_fetched }}</td>
                                    <td style="text-align: right;">{{ log.records_saved }}</td>
                                    <td style="max-width: 180px; overflow: hidden; text-overflow: ellipsis;">
                                        {{ log.error_message || (log.details ? JSON.stringify(log.details) : '-') }}
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div v-if="admin.taskLogs.length === 0"
                        style="text-align: center; padding: 2rem; color: var(--text-muted);">
                        ÊöÇÊó†‰ªªÂä°Êó•Âøó
                    </div>
                </div>

                <!-- Áî®Êà∑‰ø°ÊÅØÂºπÁ™ó -->
                <div v-if="admin.showUserInfo" class="modal-overlay" @click.self="admin.showUserInfo = false">
                    <div class="modal-content" style="min-width: 300px;">
                        <div class="card-header">
                            Áî®Êà∑‰ø°ÊÅØ
                            <span style="float: right; cursor: pointer;" @click="admin.showUserInfo = false">‚úï</span>
                        </div>
                        <div style="padding: 0.5rem 0;">
                            <p><strong>Áî®Êà∑ÂêçÔºö</strong>{{ admin.userInfoData.username }}</p>
                            <p><strong>QQÔºö</strong>{{ admin.userInfoData.qq_number }}</p>
                            <p><strong>ËßíËâ≤Ôºö</strong>{{ admin.userInfoData.role }}</p>
                            <p><strong>Áä∂ÊÄÅÔºö</strong>{{ admin.userInfoData.status }}</p>
                            <p><strong>Ê≥®ÂÜåÊó∂Èó¥Ôºö</strong>{{ formatDate(admin.userInfoData.created_at) }}</p>
                        </div>
                    </div>
                </div>

                <!-- API Ë∞ÉÁî®ËØ¶ÊÉÖÂºπÁ™ó -->
                <div v-if="admin.showDetails" class="modal-overlay" @click.self="admin.showDetails = false">
                    <div class="modal-content">
                        <div class="card-header">
                            {{ admin.detailsUser }} ÁöÑË∞ÉÁî®ËÆ∞ÂΩï
                            <span style="float: right; cursor: pointer;" @click="admin.showDetails = false">‚úï</span>
                        </div>
                        <div style="max-height: 400px; overflow-y: auto;">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Êé•Âè£</th>
                                        <th>ÂèÇÊï∞</th>
                                        <th>Êó∂Èó¥</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="d in admin.apiDetails">
                                        <td>{{ d.endpoint }}</td>
                                        <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">
                                            {{ d.query_params ? JSON.stringify(d.query_params) : '-' }}
                                        </td>
                                        <td style="white-space: nowrap;">{{ formatDateTime(d.created_at) }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ÂÖ¨‰ºöÊü•ËØ¢ Tab -->
            <div v-show="currentTab === 'clan' && (!auth.isLoggedIn || auth.status === 'active')">
                <div class="card">
                    <div class="tab-container">
                        <button class="tab-btn" :class="{ active: clan.mode === 'history' }"
                            @click="clan.mode = 'history'">
                            ÂÖ¨‰ºöÂéÜÂè≤
                        </button>
                        <button class="tab-btn" :class="{ active: clan.mode === 'details' }"
                            @click="clan.mode = 'details'; loadClanPeriodOptions()">
                            ÂÖ¨‰ºöËØ¶ÊÉÖ
                        </button>
                        <button class="tab-btn" :class="{ active: clan.mode === 'profiles' }"
                            @click="clan.mode = 'profiles'; loadDateOptions()">
                            Êó•ÊúüÂéÜÂè≤
                        </button>
                    </div>

                    <!-- ÂÖ¨‰ºöÂéÜÂè≤Êü•ËØ¢Ë°®Âçï -->
                    <div v-if="clan.mode === 'history'">
                        <div class="form-row">
                            <div class="form-group" style="flex: 2;">
                                <input type="text" class="form-control" placeholder="ÂÖ¨‰ºöÂêç" v-model="clan.searchName"
                                    @input="clan.searchId = ''" @keyup.enter="searchClanHistory">
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <input type="text" class="form-control" placeholder="ÂÖ¨‰ºöID" v-model="clan.searchId"
                                    @input="clan.searchName = ''" @keyup.enter="searchClanHistory">
                            </div>
                            <div class="form-group">
                                <button class="btn" @click="searchClanHistory" :disabled="clan.loading">
                                    {{ clan.loading ? 'Êü•ËØ¢‰∏≠' : 'Êü•ËØ¢' }}
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- ÂÖ¨‰ºöËØ¶ÊÉÖÊü•ËØ¢Ë°®Âçï -->
                    <div v-if="clan.mode === 'details'">
                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <select class="form-control" v-model="clan.searchPeriod">
                                    <option v-for="p in clan.periodOptions" :value="p">{{ p }}</option>
                                </select>
                            </div>
                            <div class="form-group" style="flex: 2;">
                                <input type="text" class="form-control" placeholder="ÂÖ¨‰ºöÂêç" v-model="clan.searchName"
                                    @input="clan.searchId = ''" @keyup.enter="searchClanDetails">
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <input type="text" class="form-control" placeholder="ÂÖ¨‰ºöID" v-model="clan.searchId"
                                    @input="clan.searchName = ''" @keyup.enter="searchClanDetails">
                            </div>
                            <div class="form-group">
                                <button class="btn" @click="searchClanDetails" :disabled="clan.loading">
                                    {{ clan.loading ? 'Êü•ËØ¢‰∏≠' : 'Êü•ËØ¢' }}
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Êó•ÊúüÂéÜÂè≤Êü•ËØ¢Ë°®Âçï -->
                    <div v-if="clan.mode === 'profiles'">
                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <select class="form-control" v-model="clan.searchDate" @change="loadTopClans()">
                                    <option v-for="d in clan.dateOptions" :value="d">{{ d }}</option>
                                </select>
                            </div>
                            <div class="form-group" style="flex: 2;">
                                <select class="form-control" v-model="clan.selectedClanId">
                                    <option value="">ÂÖ®ÈÉ®ÂÖ¨‰ºö</option>
                                    <option v-for="c in clan.topClans" :value="c.clan_id">{{ c.ranking }}. {{
                                        c.clan_name }} ({{ c.clan_id }})</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <button class="btn" @click="searchClanProfiles" :disabled="clan.loading">
                                    {{ clan.loading ? 'Êü•ËØ¢‰∏≠' : 'Êü•ËØ¢' }}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ÂÖ¨‰ºöÂéÜÂè≤ÁªìÊûú -->
                <div class="card" v-if="clan.mode === 'history' && clan.result">
                    <div class="card-header">{{ clan.result.clan_name }}({{ clan.result.clan_id }}) ÂéÜÂè≤ÊéíÂêç</div>
                    <table>
                        <thead>
                            <tr>
                                <th>ÊúüÊ¨°</th>
                                <th>ÂÖ¨‰ºöÂêç</th>
                                <th>ÊéíÂêç</th>
                                <th>‰∫∫Êï∞</th>
                                <th>‰ºöÈïø</th>
                                <th>‰ºöÈïøID</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="h in clan.result.history">
                                <td>{{ h.period }}</td>
                                <td>{{ h.clan_name }}</td>
                                <td>{{ h.ranking }}{{ h.is_estimate ? '*' : '' }}</td>
                                <td>{{ h.member_num }}</td>
                                <td>{{ h.leader_name }}</td>
                                <td>{{ h.leader_viewer_id }}</td>
                            </tr>
                        </tbody>
                    </table>
                    <p style="color: var(--text-muted); font-size: 0.9rem;">* Ë°®Á§∫ÂΩìÊúüÈ¢Ñ‰º∞ÊéíÂêç</p>
                </div>

                <!-- ÂÖ¨‰ºöËØ¶ÊÉÖÁªìÊûú -->
                <div class="card" v-if="clan.mode === 'details' && clan.detailsResult">
                    <div class="card-header">{{ clan.detailsResult.clan_name }}({{ clan.detailsResult.clan_id }}) ÂÖ±{{
                        clan.detailsResult.member_count }}‰∫∫</div>
                    <table>
                        <thead>
                            <tr>
                                <th>ËÅåÂä°</th>
                                <th>Áé©ÂÆ∂Âêç</th>
                                <th>Á≠âÁ∫ß</th>
                                <th>ÊàòÂäõ</th>
                                <th>ID</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="m in clan.detailsResult.members" :key="m.viewer_id">
                                <td>{{ m.role }}</td>
                                <td>{{ m.name }}</td>
                                <td>{{ m.level }}</td>
                                <td>{{ m.total_power }}</td>
                                <td>{{ m.viewer_id }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>


                <!-- ÂâçÊéíÊàêÂëòÁªìÊûú -->
                <div class="card" v-if="clan.mode === 'profiles' && clan.profilesResult">
                    <div class="card-header">{{ clan.profilesResult.clan_name ? clan.profilesResult.clan_name + '(' +
                        clan.profilesResult.clan_id + ')' : clan.profilesResult.date }} ÂÖ±{{ clan.profilesResult.count
                        }}‰∫∫</div>
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 7%;">#</th>
                                <th @click="sortProfiles('join_clan_name')" style="cursor: pointer;">
                                    ÂÖ¨‰ºö {{ clan.sortColumn === 'join_clan_name' ? (clan.sortAsc ? '‚Üë' : '‚Üì') : '' }}
                                </th>
                                <th @click="sortProfiles('user_name')" style="cursor: pointer;">
                                    Áé©ÂÆ∂Âêç {{ clan.sortColumn === 'user_name' ? (clan.sortAsc ? '‚Üë' : '‚Üì') : '' }}
                                </th>
                                <th @click="sortProfiles('team_level')" style="cursor: pointer; width: 6%;">
                                    Á≠âÁ∫ß {{ clan.sortColumn === 'team_level' ? (clan.sortAsc ? '‚Üë' : '‚Üì') : '' }}
                                </th>
                                <th @click="sortProfiles('unit_num')" style="cursor: pointer; width: 6%;">
                                    ËßíËâ≤ {{ clan.sortColumn === 'unit_num' ? (clan.sortAsc ? '‚Üë' : '‚Üì') : '' }}
                                </th>
                                <th @click="sortProfiles('total_power')" style="cursor: pointer; width: 10%;">
                                    ÊàòÂäõ {{ clan.sortColumn === 'total_power' ? (clan.sortAsc ? '‚Üë' : '‚Üì') : '' }}
                                </th>
                                <th @click="sortProfiles('knight_level')" style="cursor: pointer; width: 10%;">
                                    È™ëÂ£´Á≠âÁ∫ß {{ clan.sortColumn === 'knight_level' ? (clan.sortAsc ? '‚Üë' : '‚Üì') : '' }}
                                </th>
                                <th @click="sortProfiles('talent_done')" style="cursor: pointer; width: 10%;">
                                    Ê∑±ÂüüÂÆåÊàê {{ clan.sortColumn === 'talent_done' ? (clan.sortAsc ? '‚Üë' : '‚Üì') : '' }}
                                </th>
                                <th @click="sortProfiles('arena_rank')" style="cursor: pointer; width: 8%;">
                                    JJC {{ clan.sortColumn === 'arena_rank' ? (clan.sortAsc ? '‚Üë' : '‚Üì') : '' }}
                                </th>
                                <th @click="sortProfiles('grand_arena_rank')" style="cursor: pointer; width: 8%;">
                                    PJJC {{ clan.sortColumn === 'grand_arena_rank' ? (clan.sortAsc ? '‚Üë' : '‚Üì') : '' }}
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="(p, idx) in clan.profilesResult.players" :key="p.viewer_id">
                                <td>{{ idx + 1 }}</td>
                                <td>{{ p.join_clan_name }}</td>
                                <td>{{ p.user_name }}</td>
                                <td>{{ p.team_level }}</td>
                                <td>{{ p.unit_num }}</td>
                                <td>{{ p.total_power }}</td>
                                <td>{{ p.knight_level }}</td>
                                <td>{{ p.talent_done }}/{{ clan.profilesResult.talent_total }}</td>
                                <td>{{ p.arena_rank }}</td>
                                <td>{{ p.grand_arena_rank }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="error" v-if="clan.error">{{ clan.error }}</div>
            </div>

            <!-- ÂèåÂú∫ÊéíÂêç Tab -->
            <div v-show="currentTab === 'grand' && (!auth.isLoggedIn || auth.status === 'active')">
                <div class="card">
                    <div class="tab-container">
                        <button class="tab-btn" :class="{ active: grand.mode === 'param_ranking' }"
                            @click="grand.mode = 'param_ranking'">
                            PÂú∫ËÉúÂú∫Êï∞
                        </button>
                    </div>

                    <div v-if="grand.mode === 'param_ranking'">
                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <select class="form-control" v-model="grand.group" @change="searchGrandWinning">
                                    <option value="0">ÂÖ®ÈÉ®ÂàÜÂú∫</option>
                                    <option v-for="g in 10" :value="g">{{ g }} Âú∫</option>
                                </select>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <select class="form-control" v-model="grand.limit" @change="searchGrandWinning">
                                    <option value="50">Ââç 50</option>
                                    <option value="100">Ââç 100</option>
                                    <option value="200">Ââç 200</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <button class="btn" @click="searchGrandWinning" :disabled="grand.loading">
                                    Âà∑Êñ∞
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card" v-if="grand.results.length > 0">
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Áé©ÂÆ∂Âêç</th>
                                <th>ËÉúÂú∫</th>
                                <th>ÂΩìÂâçÊéíÂêç</th>
                                <th>ÂàÜÂú∫</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="row in grand.results">
                                <td>{{ row.rank }}</td>
                                <td>{{ row.user_name }}</td>
                                <td>{{ row.winning_number }}</td>
                                <td>{{ row.grand_arena_rank }}</td>
                                <td>{{ row.grand_arena_group }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Áé©ÂÆ∂Êü•ËØ¢ Tab -->
            <div v-show="currentTab === 'player' && (!auth.isLoggedIn || auth.status === 'active')">
                <div class="card">
                    <div class="tab-container">
                        <button class="tab-btn" :class="{ active: player.mode === 'clan_history' }"
                            @click="player.mode = 'clan_history'">
                            Áé©ÂÆ∂ÂÖ¨‰ºöÂéÜÂè≤
                        </button>
                        <button class="tab-btn" :class="{ active: player.mode === 'search' }"
                            @click="player.mode = 'search'; loadPeriodOptions()">
                            Áé©ÂÆ∂Êü•ËØ¢
                        </button>
                    </div>

                    <!-- ÂÖ¨‰ºöÂéÜÂè≤Êü•ËØ¢Ë°®Âçï -->
                    <div v-if="player.mode === 'clan_history'">
                        <div class="form-row">
                            <div class="form-group" style="flex: 3;">
                                <input type="number" class="form-control" placeholder="ËæìÂÖ• 13 ‰Ωç viewer_id"
                                    v-model="player.viewerId" @keyup.enter="searchPlayerHistory">
                            </div>
                            <div class="form-group">
                                <button class="btn" @click="searchPlayerHistory" :disabled="player.loading">
                                    Êü•ËØ¢
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Áé©ÂÆ∂ÊêúÁ¥¢Ë°®Âçï -->
                    <div v-if="player.mode === 'search'">
                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <select class="form-control" v-model="player.searchPeriod">
                                    <option v-for="p in player.periodOptions" :value="p">{{ p }}</option>
                                </select>
                            </div>
                            <div class="form-group" style="flex: 2;">
                                <input type="text" class="form-control" placeholder="Áé©ÂÆ∂ÂêçÔºàÊ®°Á≥äÂåπÈÖçÔºâ"
                                    v-model="player.searchName" @keyup.enter="searchPlayers">
                            </div>
                            <div class="form-group">
                                <button class="btn" @click="searchPlayers" :disabled="player.loading">
                                    Êü•ËØ¢
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ÂÖ¨‰ºöÂéÜÂè≤ÁªìÊûú -->
                <div class="card" v-if="player.mode === 'clan_history' && player.result">
                    <div class="card-header">{{ player.result.user_name }} ÂÖ¨‰ºöÂéÜÂè≤</div>
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 80px;">ÊúüÊ¨°</th>
                                <th style="width: 140px;">Áé©ÂÆ∂Âêç</th>
                                <th style="width: 160px;">ÂÖ¨‰ºö</th>
                                <th style="width: 80px;">ÂÖ¨‰ºöÊéíÂêç</th>
                                <th style="width: 60px;">Á≠âÁ∫ß</th>
                                <th style="width: 100px;">ÊàòÂäõ</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="h in player.result.history">
                                <td>{{ h.period }}</td>
                                <td>{{ h.player_name }}</td>
                                <td>{{ h.clan_name }}</td>
                                <td>{{ h.clan_ranking }}</td>
                                <td>{{ h.level }}</td>
                                <td>{{ h.total_power }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Áé©ÂÆ∂ÊêúÁ¥¢ÁªìÊûú -->
                <div class="card" v-if="player.mode === 'search' && player.searchResults.length > 0">
                    <div class="card-header">ÊêúÁ¥¢ÁªìÊûú ({{ player.searchResults.length }})</div>
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Áé©ÂÆ∂Âêç</th>
                                <th>Á≠âÁ∫ß</th>
                                <th>ÊàòÂäõ</th>
                                <th>ÂÖ¨‰ºö</th>
                                <th>Viewer ID</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="(row, idx) in player.searchResults">
                                <td>{{ idx + 1 }}</td>
                                <td>{{ row.name }}</td>
                                <td>{{ row.level }}</td>
                                <td>{{ row.total_power }}</td>
                                <td>{{ row.clan_name }}</td>
                                <td>{{ row.viewer_id }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="error" v-if="player.error">{{ player.error }}</div>
            </div>
        </div>
    </div>

    <script type="module" src="/static/js/main.js"></script>
</body>

</html>